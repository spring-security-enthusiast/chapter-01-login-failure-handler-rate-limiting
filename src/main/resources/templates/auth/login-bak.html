<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="https://www.thymeleaf.org"
      lang="en">
<!-- CORRECT -->
<head th:replace="~{fragment/template :: authHead('Spring Security Bank â€“ Login')}"></head>
<body>
<div class="layout">
    <!-- Top bar -->
    <header th:replace="~{fragment/template :: topbarPublic}"></header>

    <!-- Login card -->
    <main class="main">
        <section class="card">
            <header class="card-header">
                <span class="env-pill">
                    <span class="env-dot"></span>
                    Login Â· Forward flow
                </span>
                <h1 class="card-title">Sign in to your account</h1>
                <p class="card-subtitle">
                    Use the demo credentials to simulate a real online banking login.
                </p>
            </header>

            <!-- Global error based on param.error / SPRING_SECURITY_LAST_EXCEPTION -->
            <div class="error-block" th:if="${loginErrorMessage != null}">
                <div class="alert-error" th:text="${loginErrorMessage}">
                    <strong>Login failed.</strong>
                </div>

                <!-- ðŸ”½ Only shown when we have a lock -->
                <div class="mt-3 small text-warning"
                     th:if="${lockUntilEpochMillis != null}"
                     id="lock-countdown"
                     th:attr="data-lock-until-ms=${lockUntilEpochMillis}">
                    Please wait
                    <strong>
                        <span id="lock-countdown-value"
                    th:text="${lockRemainingSeconds}">60</span>
                        seconds
                    </strong>
                    before trying again.
                </div>
            </div>


            <form th:action="@{/auth/login_processing}" method="post">
                <!-- CSRF token (if enabled) -->
                <input type="hidden"
                       th:name="${_csrf.parameterName}"
                       th:value="${_csrf.token}" />

                <div class="form-group">
                    <label for="username">Username</label>
                    <div class="input-wrapper">
                        <input type="text"
                               id="username"
                               name="username"
                               placeholder="e.g. admin"
                               autocomplete="username"
                               value="admin" />
                    </div>
                    <div class="hint">
                        For this demo, the username is <code>admin</code>.
                    </div>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="input-wrapper">
                        <input type="password"
                               id="password"
                               name="password"
                               placeholder="Enter your password"
                               autocomplete="current-password"
                               value="password" />
                    </div>
                    <div class="hint">
                        Demo password is <code>password</code>.
                    </div>
                </div>

                <div class="actions-row">
                    <button id="login-submit-btn"
                            class="btn btn-primary w-100"
                            type="submit">
                        <span>Log in</span>
                        <span>â†’</span>
                    </button>
                    <div class="demo-tag">
                        Demo user:&nbsp;<code>admin/password</code>
                    </div>
                </div>
            </form>



            <div class="demo-hint-box">
                <b>How this demo works:</b><br />
                This login form submits credentials to
                <code>/auth/login_processing</code>.
                After a successful login, Spring Security executes a custom
                <code>successHandler</code>, which <b>forwards</b> the same
                <code>POST</code> request internally to
                <code>/customSuccessPage</code>.
            </div>

            <div class="footer-note">
                Try logging in and observe what happens:
                the browser URL stays the same, but the view changes.
                This means the request was forwarded internally,
                not redirected to a new URL.
            </div>

        </section>
    </main>

    <footer th:replace="~{fragment/template :: footer}"></footer>

    <script>
        (function() {
            const countdownEl = document.getElementById('lock-countdown');
            if (!countdownEl) {
                return; // Not locked, nothing to do
            }

            const lockUntilMs = parseInt(countdownEl.getAttribute('data-lock-until-ms') || '0', 10);
            if (!lockUntilMs || isNaN(lockUntilMs)) {
                return;
            }

            const valueEl = document.getElementById('lock-countdown-value');
            const submitBtn = document.getElementById('login-submit-btn');

            // Optional: disable submit while locked
            if (submitBtn) {
                submitBtn.disabled = true;
            }

            function updateCountdown() {
                const now = Date.now();
                const remainingMs = lockUntilMs - now;
                const remainingSeconds = Math.ceil(remainingMs / 1000);

                if (remainingSeconds <= 0) {
                    if (valueEl) {
                        valueEl.textContent = '0';
                    }
                    if (submitBtn) {
                        submitBtn.disabled = false;
                    }
                    // Optional: auto-refresh to clear ?error=locked from URL
                    // window.location.href = window.location.pathname;
                    clearInterval(timerId);
                    return;
                }

                if (valueEl) {
                    valueEl.textContent = remainingSeconds.toString();
                }
            }

            // Initial draw + interval
            updateCountdown();
            const timerId = setInterval(updateCountdown, 1000);
        })();
    </script>

</div>
</body>
</html>
